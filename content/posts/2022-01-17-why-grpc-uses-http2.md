---
date: 2022-01-17
title: 'gPRC ä¸ºä»€ä¹ˆä½¿ç”¨ HTTP/2'
template: post
thumbnail: '../thumbnails/grpc.png'
slug: why-grpc-uses-http2
categories:
  - Tech
  - Thinking
  - Popular
tags:
  - gRPC
  - RPC
  - HTTP
---

## 0. å†™åœ¨å‰é¢

å› ä¸ºæœ¬äººä¹‹å‰åªä½¿ç”¨è¿‡ Thriftï¼Œæ‰€ä»¥åœ¨çœŸæ­£ä½¿ç”¨ gRPC å¹¶å‘ç°å®ƒæœ‰ HTTP Header ä¹‹åï¼Œè„‘æµ·ä¸­ä¾¿äº§ç”Ÿäº†ä¸€ä¸ªå¤§å¤§çš„é—®å·ï¼Œä¸ºä»€ä¹ˆä¸€ä¸ª RPC æ¡†æ¶è¦è·Ÿ HTTP æ··åœ¨ä¸€èµ·å‘¢ï¼Ÿæ¯”å¦‚ä¹‹å‰ä½¿ç”¨è¿‡çš„ Thrift å°±æ˜¯ä¸€ä¸ªå¾ˆå•çº¯çš„ RPC æ¡†æ¶ï¼Œå®ƒæœ¬èº«å¹¶ä¸æ”¯æŒé€šè¿‡ HTTP è¿›è¡Œè®¿é—®ï¼Œæ‰€ä»¥åœ¨æˆ‘çœ‹æ¥ï¼ŒRPC ä¹Ÿæ˜¯ä¸€ç§åº”ç”¨å±‚åè®®ï¼Œé‚£ä¸ºä»€ä¹ˆè¦è·ŸåŒä¸ºåº”ç”¨å±‚çš„ HTTP åè®®æ··æ·†åœ¨ä¸€èµ·å‘¢ï¼ŸgRPC ä¸ºä»€ä¹ˆè¦åŸºäº HTTP/2 è€Œä¸æ˜¯åƒ Thrift ä¸€æ ·è‡ªå·±å®ç°ä¸€å¥—åº”ç”¨å±‚åè®®å‘¢ï¼Ÿ

äºæ˜¯ä¾¿æœ‰äº†è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘åœ¨åšäº†ä¸€äº›æœç´¢å¹¶å›é¡¾äº† HTTP çš„å‘å±•å†ç¨‹åï¼Œæ¥å°è¯•å›ç­”ä¸€ä¸‹è‡ªå·±çš„é—®é¢˜ã€‚

é˜²æ  PSï¼šRPC ï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰æ˜¯ä¸€ä¸ªå¾ˆå®½æ³›çš„æ¦‚å¿µï¼ŒHTTP å…¶å®åœ¨æŸç§æ„ä¹‰ä¸Šæˆ‘è§‰å¾—ä¹Ÿå¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç‰¹æ®Šçš„ RPCï¼ŒDNS è§£æåˆ™æ˜¯å®ƒçš„æœåŠ¡å‘ç°ã€‚ä¸è¿‡æœ¬æ–‡æ‰€æŒ‡çš„ RPC éƒ½æ˜¯ RPC æ¡†æ¶è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„è¿œç¨‹è°ƒç”¨æ–¹æ¡ˆï¼ˆåŒ…æ‹¬æ¥å£è§„èŒƒã€åºåˆ—åŒ–ååºåˆ—åŒ–è§„èŒƒã€é€šä¿¡åè®®ç­‰ï¼‰ï¼Œä¸”å¹¶ä¸æ·±å…¥è®¨è®ºå®½æ³›çš„ RPC æ¦‚å¿µä¸ HTTPï¼Œæœ‰å…´è¶£å¯å‚è§ [æ—¢ç„¶æœ‰ HTTP è¯·æ±‚ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨ RPC è°ƒç”¨ï¼Ÿ - æ˜“å“¥çš„å›ç­” - çŸ¥ä¹](https://www.zhihu.com/question/41609070/answer/1030913797)ã€‚

## 1. HTTP/1.0 => HTTP/1.1

ç½‘ç»œä¸Šå·²ç»æœ‰å¾ˆå¤šçš„æ–‡ç« ä¸åšå®¢å†™è¿‡ HTTP/1.0 ä¸ HTTP/1.1 çš„å¼‚åŒä¸æ”¹è¿›ç‚¹ï¼Œæœ¬æ–‡æ­¤éƒ¨åˆ†ä¸»è¦ä¹Ÿæ‘˜è‡ª [HTTP 2.0 çš„é‚£äº›äº‹](https://segmentfault.com/a/1190000004399183)ï¼Œï¼ˆä¿®æ”¹äº†ä¸€ç‚¹ç‚¹ï¼‰ï¼Œä»¥å¤‡æœ¬äººå›é¡¾å¤ä¹ ä¹‹ç”¨ã€‚

#### 1.1 HTTP/1.0 çš„é—®é¢˜

HTTP/1.0 è¢«æŠ±æ€¨æœ€å¤šçš„å°±æ˜¯**è¿æ¥æ— æ³•å¤ç”¨**ï¼Œå’Œ**é˜Ÿå¤´é˜»å¡ head of line blocking** ï¼ˆä»¥ä¸‹ç®€ç§° HOL blockingï¼‰è¿™ä¸¤ä¸ªé—®é¢˜ã€‚ç†è§£è¿™ä¸¤ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªååˆ†é‡è¦çš„å‰æï¼šå®¢æˆ·ç«¯æ˜¯ä¾æ®åŸŸåæ¥å‘æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œä¸€èˆ¬ PC ç«¯æµè§ˆå™¨ä¼šé’ˆå¯¹å•ä¸ªåŸŸåçš„ server åŒæ—¶å»ºç«‹ 6ï½8 ä¸ªè¿æ¥ï¼Œæ‰‹æœºç«¯çš„è¿æ¥æ•°åˆ™ä¸€èˆ¬æ§åˆ¶åœ¨ 4ï½6 ä¸ªã€‚æ˜¾ç„¶è¿æ¥æ•°å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œèµ„æºå¼€é”€å’Œæ•´ä½“å»¶è¿Ÿéƒ½ä¼šéšä¹‹å¢å¤§ã€‚

**è¿æ¥æ— æ³•å¤ç”¨**ä¼šå¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½ç»å† TCP çš„ä¸‰æ¬¡æ¡æ‰‹å’Œæ…¢å¯åŠ¨ã€‚ä¸‰æ¬¡æ¡æ‰‹åœ¨é«˜å»¶è¿Ÿçš„åœºæ™¯ä¸‹å½±å“è¾ƒæ˜æ˜¾ï¼Œæ…¢å¯åŠ¨åˆ™å¯¹æ–‡ä»¶ç±»å¤§è¯·æ±‚å½±å“è¾ƒå¤§ã€‚

**HOL blocking** ä¼šå¯¼è‡´å¸¦å®½æ— æ³•è¢«å……åˆ†åˆ©ç”¨ï¼Œä»¥åŠåç»­å¥åº·è¯·æ±‚è¢«é˜»å¡ã€‚å‡è®¾æœ‰ 5 ä¸ªè¯·æ±‚åŒæ—¶å‘å‡ºï¼Œå¯¹äº HTTP/1.0 çš„å®ç°ï¼Œåœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚æ²¡æœ‰æ”¶åˆ°å›å¤ä¹‹å‰ï¼Œåç»­ä»åº”ç”¨å±‚å‘å‡ºçš„è¯·æ±‚åªèƒ½æ’é˜Ÿï¼Œè¯·æ±‚ 2/3/4/5 åªèƒ½ç­‰è¯·æ±‚ 1 çš„ response å›æ¥ä¹‹åæ‰èƒ½é€ä¸ªå‘å‡ºã€‚ç½‘ç»œé€šç•…çš„æ—¶å€™æ€§èƒ½å½±å“ä¸å¤§ï¼Œä¸€æ—¦è¯·æ±‚ 1 çš„ request å› ä¸ºä»€ä¹ˆåŸå› æ²¡æœ‰æŠµè¾¾æœåŠ¡å™¨ï¼Œæˆ–è€… response å› ä¸ºç½‘ç»œé˜»å¡æ²¡æœ‰åŠæ—¶è¿”å›ï¼Œå½±å“çš„å°±æ˜¯æ‰€æœ‰åç»­è¯·æ±‚ï¼Œé—®é¢˜å°±å˜å¾—æ¯”è¾ƒä¸¥é‡äº†ã€‚

#### 1.2 è§£å†³è¿æ¥æ— æ³•å¤ç”¨

HTTP/1.0  é‡Œé»˜è®¤å¹¶ä¸ä½¿ç”¨é•¿è¿æ¥ï¼Œä½†åœ¨åè®®å¤´é‡Œå¯ä»¥è®¾ç½® `Connection:keep-alive`ï¼Œè®¾ç½®åå¯ä»¥åœ¨ä¸€å®šæ—¶é—´å†…å¤ç”¨è¿æ¥ï¼Œå…·ä½“å¤ç”¨æ—¶é—´çš„é•¿çŸ­å¯ä»¥ç”±æœåŠ¡å™¨æ§åˆ¶ï¼Œæ¯”å¦‚ä½¿ç”¨ [`Keep-Alive`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Keep-Alive) åè®®å¤´æ¥æŒ‡å®šä¸€ä¸ªæœ€å°çš„è¿æ¥ä¿æŒæ—¶é—´ï¼ˆå¦‚ ` Keep-Alive: timeout=5, max=1000`ï¼‰ã€‚æ­¤å¤–ï¼ŒæŠŠ `Connection` è®¾ç½®æˆ `close` ä»¥å¤–çš„å…¶å®ƒå‚æ•°éƒ½å¯ä»¥è®©å…¶ä¿æŒé•¿è¿æ¥ï¼Œé€šå¸¸ä¼šè®¾ç½®ä¸º `retry-after`ã€‚

åœ¨ HTTP/1.1 é‡Œé»˜è®¤å°±æ˜¯é•¿è¿æ¥çš„ï¼Œ å³ `Connection` çš„é»˜è®¤å€¼å°±æ˜¯ `keep-alive`ï¼Œåè®®å¤´éƒ½ä¸ç”¨å†å»å£°æ˜å®ƒ (ä½†æˆ‘ä»¬è¿˜æ˜¯ä¼šæŠŠå®ƒåŠ ä¸Šï¼Œä¸‡ä¸€æŸä¸ªæ—¶å€™å› ä¸ºæŸç§åŸå› è¦é€€å›åˆ° HTTP/1.0 å‘¢)ã€‚å¦‚æœè¦å…³é—­è¿æ¥å¤ç”¨éœ€è¦æ˜¾å¼åœ°è®¾ç½® `Connection:close`ã€‚ä¸€æ®µæ—¶é—´å†…çš„è¿æ¥å¤ç”¨å¯¹ PC ç«¯æµè§ˆå™¨çš„ä½“éªŒå¸®åŠ©å¾ˆå¤§ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„è¯·æ±‚åœ¨é›†ä¸­åœ¨ä¸€å°æ®µæ—¶é—´ä»¥å†…ã€‚ä½†å¯¹ç§»åŠ¨ app æ¥è¯´ï¼Œæˆæ•ˆä¸å¤§ï¼Œapp ç«¯çš„è¯·æ±‚æ¯”è¾ƒåˆ†æ•£ä¸”æ—¶é—´è·¨åº¦ç›¸å¯¹è¾ƒå¤§ã€‚

#### 1.3 è§£å†³é˜Ÿå¤´é˜»å¡ HOL Blocking

HOL blocking æ˜¯ HTTP/2.0 ä¹‹å‰ç½‘ç»œä½“éªŒçš„æœ€å¤§ç¥¸æºã€‚å› ä¸ºå¥åº·çš„è¯·æ±‚ä¼šè¢«ä¸å¥åº·çš„è¯·æ±‚å½±å“ï¼Œè€Œä¸”è¿™ç§ä½“éªŒçš„æŸè€—å—ç½‘ç»œç¯å¢ƒå½±å“ï¼Œå‡ºç°éšæœºä¸”éš¾ä»¥ç›‘æ§ã€‚ä¸ºäº†è§£å†³ HOL blocking å¸¦æ¥çš„å»¶è¿Ÿï¼Œåè®®è®¾è®¡è€…è®¾è®¡äº†ä¸€ç§æ–°çš„ pipelining æœºåˆ¶ã€‚

åŒæ ·å‡è®¾æœ‰ 5 ä¸ªè¯·æ±‚åŒæ—¶å‘å‡ºï¼Œå’Œ HTTP/1.0 ç›¸æ¯”æœ€å¤§çš„å·®åˆ«æ˜¯ï¼ŒHTTP/1.1 çš„è¯·æ±‚ 2/3/4/5 ä¸ç”¨ç­‰è¯·æ±‚ 1 çš„ response è¿”å›ä¹‹åæ‰å‘å‡ºï¼Œè€Œæ˜¯å‡ ä¹åœ¨åŒä¸€æ—¶é—´æŠŠ request å‘å‘äº†æœåŠ¡å™¨ã€‚è¯·æ±‚ 2/3/4/5 åŠæ‰€æœ‰åç»­å…±ç”¨è¯¥è¿æ¥çš„è¯·æ±‚èŠ‚çº¦äº†ç­‰å¾…çš„æ—¶é—´ï¼Œæå¤§åœ°é™ä½äº†æ•´ä½“å»¶è¿Ÿã€‚

ä¸è¿‡ pipelining å¹¶ä¸æ˜¯æ•‘ä¸–ä¸»ï¼Œå®ƒä¹Ÿå­˜åœ¨ä¸å°‘ç¼ºé™·ï¼š

- pipelining åªèƒ½é€‚ç”¨äº HTTP/1.1ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ”¯æŒ HTTP/1.1 çš„ server éƒ½è¦æ±‚æ”¯æŒ pipeliningã€‚
- **åªæœ‰å¹‚ç­‰çš„è¯·æ±‚ï¼ˆGET/HEAD/PUT/DELETE ç­‰ï¼‰èƒ½ä½¿ç”¨ pipelining**ï¼Œéå¹‚ç­‰è¯·æ±‚æ¯”å¦‚ POST ä¸èƒ½ä½¿ç”¨ï¼Œå› ä¸ºè¯·æ±‚ä¹‹é—´å¯èƒ½ä¼šå­˜åœ¨å…ˆåä¾èµ–å…³ç³»ã€‚
- HOL blocking å¹¶æ²¡æœ‰å®Œå…¨å¾—åˆ°è§£å†³ï¼Œ**server çš„ response è¿˜æ˜¯è¦æ±‚ä¾æ¬¡è¿”å›**ï¼Œéµå¾ª FIFOï¼ˆfirst in first outï¼‰åŸåˆ™ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœè¯·æ±‚ 1 çš„ response æ²¡æœ‰å›æ¥ï¼Œè¯·æ±‚ 2/3/4/5 çš„responseä¹Ÿä¸ä¼šè¢«é€å›æ¥ã€‚
- ç»å¤§éƒ¨åˆ†çš„ HTTP ä»£ç†æœåŠ¡å™¨ä¸æ”¯æŒ pipeliningã€‚
- å’Œä¸æ”¯æŒ pipelining çš„è€æœåŠ¡å™¨åå•†æœ‰é—®é¢˜ã€‚
- å¯èƒ½ä¼šå¯¼è‡´æ–°çš„ Front of queue blocking é—®é¢˜ã€‚

æ® [MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Connection_management_in_HTTP_1.x#http_%E6%B5%81%E6%B0%B4%E7%BA%BF)ï¼ŒHTTP æµæ°´çº¿åœ¨ç°ä»£æµè§ˆå™¨ä¸­å¹¶ä¸æ˜¯é»˜è®¤è¢«å¯ç”¨çš„ã€‚Chrome åˆ™æ˜¯ç§»é™¤äº† enable pipelining çš„é€‰é¡¹ï¼Œè¯¦æƒ…å¯å‚è§æ­¤[é—®é¢˜æè¿°](https://www.chromium.org/developers/design-documents/network-stack/http-pipelining/)ã€‚

#### 1.4 HTTP/1.1 çš„å…¶ä»–ä¼˜åŒ–

- æ”¯æŒåŒæ—¶æ‰“å¼€å¤šä¸ª TCP è¿æ¥
- æ”¯æŒè™šæ‹Ÿä¸»æœº
- æ–°å¢çŠ¶æ€ç  100
- æ”¯æŒåˆ†å—ä¼ è¾“ç¼–ç 
- æ–°å¢ç¼“å­˜å¤„ç†æŒ‡ä»¤ max-age

## 2. HTTP/1.1 => HTTP/2

HTTP/2 ä»åè®®å±‚ä¼˜åŒ–äº† HTTP/1.x è€Œä¸æ˜¯å¦‚åŒ HTTP/1.1 ä¸€æ ·ä¿®ä¿®è¡¥è¡¥ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ã€‚

#### 2.1 äºŒè¿›åˆ¶åˆ†å¸§ Binary Format ä¸å¤šè·¯å¤ç”¨ Multiplexing

HTTP/1.x ä¸­çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ä¸»è¦æ˜¯å› ä¸ºåè®®æœ¬è´¨ä¸Šæ˜¯çº¯æ–‡æœ¬çš„ï¼Œåœ¨èµ„æºå—ï¼ˆresource chunksï¼‰ä¹‹é—´ä¸ä½¿ç”¨åˆ†éš”ç¬¦ã€‚ä½œä¸ºä¸€ç§è§£å†³åŠæ³•ï¼Œæµè§ˆå™¨æ‰“å¼€è®¸å¤šå¹¶è¡Œ TCP è¿æ¥ï¼Œè¿™æ—¢ä¸é«˜æ•ˆï¼Œä¹Ÿä¸å¯æ‰©å±•ã€‚å› æ­¤ï¼ŒHTTP/2 çš„ç›®æ ‡éå¸¸æ˜ç¡®ï¼š**æˆ‘ä»¬èƒ½å¤Ÿå›åˆ°å•ä¸ª TCP è¿æ¥ï¼Œè§£å†³é˜Ÿå¤´é˜»å¡é—®é¢˜**ã€‚æ¢ä¸€ç§è¯´æ³•ï¼šæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ­£ç¡®åœ°å¤ç”¨èµ„æºå—ï¼ˆresource chunksï¼‰ã€‚è¿™åœ¨ HTTP/1.x ä¸­æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºæ²¡æœ‰åŠæ³•åˆ†è¾¨ä¸€ä¸ªå—å±äºå“ªä¸ªèµ„æºï¼Œæˆ–è€…å®ƒåœ¨å“ªé‡Œç»“æŸï¼Œå¦ä¸€ä¸ªå—ä»å“ªé‡Œå¼€å§‹ã€‚HTTP/2 éå¸¸ä¼˜é›…åœ°è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼Œå®ƒåœ¨èµ„æºå—ä¹‹å‰æ·»åŠ äº†**å¸§ï¼ˆframesï¼‰**ã€‚

HTTP/2 å°†æŠ¥æ–‡åˆ†æˆ Headers å¸§å’Œ Data å¸§ç­‰ï¼Œå®ƒä»¬éƒ½æ˜¯äºŒè¿›åˆ¶æ ¼å¼çš„ã€‚åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œå¯¹å•ä¸ªåŸŸååªä¼šæœ‰ä¸€ä¸ª TCP è¿æ¥å­˜åœ¨ï¼Œå®ƒæ‰¿è½½äº†ä»»æ„æ•°é‡çš„åŒå‘æ•°æ®æµï¼ˆStreamï¼‰ã€‚

- ä¸€ä¸ªæ•°æ®æµï¼ˆStreamï¼‰éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦å’Œå¯é€‰çš„ä¼˜å…ˆçº§ä¿¡æ¯ï¼Œç”¨äºæ‰¿è½½åŒå‘ä¿¡æ¯ã€‚
- æ¶ˆæ¯ï¼ˆMessageï¼‰æ˜¯ä¸é€»è¾‘è¯·æ±‚æˆ–å“åº”å¯¹åº”çš„å®Œæ•´çš„ä¸€ç³»åˆ—å¸§ã€‚
- å¸§ï¼ˆFrameï¼‰æ˜¯æœ€å°çš„é€šä¿¡å•ä½ï¼Œæ¥è‡ªä¸åŒæ•°æ®æµçš„å¸§å¯ä»¥äº¤é”™å‘é€ï¼Œç„¶åå†æ ¹æ®æ¯ä¸ªå¸§å¤´çš„æ•°æ®æµæ ‡è¯†ç¬¦é‡æ–°ç»„è£…ã€‚

è¿™æ ·åšçš„å¥½å¤„æ˜¾è€Œæ˜“è§ï¼Œæ¯”å¦‚è¯´ï¼š

+ å‡å°‘äº† HTTPS æ—¶çš„ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼ˆéœ€è¦ 1 ä¸ª RTTï¼Œæœ€å Client Ack åç›´æ¥å¼€å§‹ TLS æ¡æ‰‹ï¼‰ã€TLS æ¡æ‰‹ï¼ˆéœ€è¦ 2 ä¸ª RTTï¼‰ã€‚
+ é¿å…äº† TCP æ…¢å¯åŠ¨çš„æ‹¥å¡æ§åˆ¶ã€‚
+ Server çš„å¹¶å‘æ•°å¾—åˆ°äº†æœ€å¤§åˆ©ç”¨ï¼Œæ¯”å¦‚å•å° Server å¹¶å‘ 1000ï¼Œé‚£ä¹ˆåŒæ—¶å¯ä»¥æ”¯æŒ 1000 ä¸ª Clientã€‚

æ­¤å¤–ï¼Œé˜Ÿå¤´é˜»å¡é—®é¢˜çš„è§£å†³è¿˜è·Ÿå¯ä»¥è®¾ç½®æµçš„ä¼˜å…ˆçº§æœ‰å…³ã€‚åœ¨æµé‡æœ‰é™çš„æ—¶å€™ï¼Œæˆ–è€…éœ€è¦ä¼˜å…ˆå“åº”æŸäº›èµ„æºçš„æ—¶å€™ï¼ŒHTTP/2 é€šè¿‡æµä¼˜å…ˆçº§ï¼ˆStream Priorityï¼‰ç­–ç•¥æ¥ç®¡ç†è¿™äº›æµï¼Œä¼˜å…ˆçº§é«˜çš„ Stream ä¼šè¢« Server ä¼˜å…ˆå¤„ç†å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æœ‰ä¸‰ç§ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯ Stream Dependenciesã€Exclusive å’Œ Dependency Weightingï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ[æ–‡æ¡£](https://www.rfc-editor.org/rfc/rfc7540#section-5.3)ã€‚

æœ€åéœ€è¦è®°ä½çš„æ˜¯ï¼ŒHTTP/2 çš„å¤šè·¯å¤ç”¨è§£å†³äº†åº”ç”¨å±‚ HOL blocking çš„é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¼ è¾“å±‚ TCP çš„ HOL blockingï¼Œå› ä¸º TCP å°† HTTP/2 æ•°æ®æŠ½è±¡ä¸ºä¸€ä¸ªå•ä¸€çš„ã€æœ‰åºçš„ã€ä½†ä¸é€æ˜çš„æµï¼Œå®ƒæŠŠæ‰€æœ‰çš„ä¸œè¥¿çœ‹ä½œä¸€ä¸ªå¤§æµã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ª TCP åŒ…ä¸¢å¤±ï¼Œæ‰€æœ‰åç»­çš„åŒ…éƒ½éœ€è¦ç­‰å¾…å®ƒçš„é‡ä¼ ï¼Œå³ä½¿å®ƒä»¬åŒ…å«æ¥è‡ªä¸åŒæµçš„æ— å…³è”æ•°æ®ã€‚æœ‰å…´è¶£å¯ä»¥å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://zhuanlan.zhihu.com/p/330300133)ã€‚

#### 2.2 æœåŠ¡ç«¯æ¨é€

HTTP/2 åœ¨å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼Œä¼šæŠŠå®¢æˆ·ç«¯éœ€è¦çš„ç›¸å…³å†…å®¹å’Œèµ„æºé¢„å…ˆæ¨é€è¿‡å»ï¼Œå®¢æˆ·ç«¯å°±ä¸éœ€è¦å†æ¬¡å‘èµ·è¯·æ±‚äº†ï¼Œæ‰€ä»¥ä¹Ÿå«ã€Œcache pushã€ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ page.html é¡µé¢ï¼ŒæœåŠ¡ç«¯å°±æŠŠ script.js å’Œ style.css ç­‰ä¸ä¹‹ç›¸å…³çš„èµ„æºä¸€èµ·å‘ç»™å®¢æˆ·ç«¯ã€‚

å¦å¤–æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®¢æˆ·ç«¯å¦‚æœé€€å‡ºæŸä¸ªä¸šåŠ¡åœºæ™¯ï¼Œå‡ºäºæµé‡æˆ–è€…å…¶å®ƒå› ç´ éœ€è¦å–æ¶ˆ server pushï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘é€ RST_STREAM ç±»å‹çš„ frame æ¥åšåˆ°ã€‚

#### 2.3 é¦–éƒ¨å‹ç¼©

HTTP/1.x çš„é¦–éƒ¨å¸¦æœ‰å¤§é‡ä¿¡æ¯ï¼Œè€Œä¸”æ¯æ¬¡éƒ½è¦é‡å¤å‘é€ã€‚HTTP/2 è¦æ±‚é€šè®¯åŒæ–¹çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ—¶ç»´æŠ¤å’Œæ›´æ–°ä¸€ä¸ªåŒ…å«ä¹‹å‰è§è¿‡çš„ header fields é¦–éƒ¨å­—æ®µè¡¨ï¼Œä»è€Œé€šè¿‡é¿å…é‡å¤ header çš„ä¼ è¾“å‡å°äº†å®é™…éœ€è¦ä¼ è¾“çš„å¤§å°ã€‚

ä¸ä»…å¦‚æ­¤ï¼Œé«˜æ•ˆçš„å‹ç¼©ç®—æ³•å¯ä»¥å¾ˆå¤§åœ°å‹ç¼© headerï¼Œå‡å°‘å‘é€åŒ…çš„æ•°é‡ä»è€Œé™ä½å»¶è¿Ÿã€‚HTTP/2.0 ä½¿ç”¨ HPACK ç¼–ç æ¥å¯¹æ•´ä¸ªå¤´éƒ¨è¿›è¡Œäº†å‹ç¼©ï¼Œå¹¶ï¼ˆ**optional**ï¼‰å¯ä»¥ä½¿ç”¨ Huffman ç¼–ç å¯¹ string å­—æ®µè¿›è¡Œå‹ç¼©ä½¿ç”¨æ›´å°‘çš„å­—ç¬¦ã€‚å…·ä½“å‹ç¼©ç»†èŠ‚å¯å‚è§[è¿™ç¯‡åšæ–‡](http://laoqingcai.com/http2-headercompression2/index.html)ï¼Œå¯¹ Huffman ç¼–ç ä¸ºä»€ä¹ˆæ˜¯å¯é€‰çš„æœ‰ç–‘æƒ‘å¯å‚è§æ­¤ [StackOverflow](https://stackoverflow.com/questions/58141642/why-is-huffman-encoding-optional-in-http-2-hpack)ã€‚

#### 2.4 æµé‡æ§åˆ¶

ä½¿ç”¨æµè¿›è¡Œå¤šè·¯å¤ç”¨ä¼šå¯¼è‡´äº‰ç”¨TCPè¿æ¥ï¼Œå¯¼è‡´æµé˜»å¡ã€‚æµé‡æ§åˆ¶æ–¹æ¡ˆç¡®ä¿åŒä¸€è¿æ¥ä¸Šçš„æµä¸ä¼šç ´åæ€§åœ°äº’ç›¸å¹²æ‰°ã€‚æµé‡æ§åˆ¶å¯ä»¥ä½œç”¨äºå•ä¸ªæµæˆ–è€…æ•´ä¸ªè¿æ¥ï¼Œæ˜¯é€è·³çš„ï¼Œè€Œä¸”**æµé‡æ§åˆ¶ä»…ä»…ä½œç”¨äº Data Frame**ã€‚

TCP åè®®é€šè¿‡ [sliding window](http://laoqingcai.com/tcp-slidingwindow/index.html) çš„ç®—æ³•æ¥åšæµé‡æ§åˆ¶ã€‚å‘é€æ–¹æœ‰ä¸ª sending windowï¼Œæ¥æ”¶æ–¹æœ‰ receive windowï¼ŒHTTP/2 çš„ flow control æ˜¯ç±»ä¼¼ receive window çš„åšæ³•ã€‚æµé‡æ§åˆ¶çª—å£ window æ˜¯ä¸€ä¸ªç®€å•çš„æ•´æ•°ï¼Œæ•°æ®çš„æ¥æ”¶æ–¹é€šè¿‡å‘ŠçŸ¥å¯¹æ–¹è‡ªå·±çš„ flow window å¤§å°è¡¨æ˜è‡ªå·±è¿˜èƒ½æ¥æ”¶å¤šå°‘æ•°æ®ï¼Œä¹Ÿè¡¨ç¤ºå…è®¸å‘é€æ–¹èƒ½ä¼ è¾“å¤šå°‘ä¸ªå…«ä½å­—èŠ‚ã€‚çª—å£çš„å¤§å°é—´æ¥è¡¡é‡äº†æ¥æ”¶è€…ç¼“å†²åŒºçš„å®¹é‡ã€‚

å¦‚æœæ¥æ”¶æ–¹åœ¨ flow window ä¸ºé›¶çš„æƒ…å†µä¸‹ä¾ç„¶æ”¶åˆ°æ›´å¤šçš„ frameï¼Œåˆ™ä¼šè¿”å› block ç±»å‹çš„ frameï¼Œè¿™å¼ åœºæ™¯ä¸€èˆ¬è¡¨æ˜ HTTP/2 çš„éƒ¨ç½²å‡ºäº†é—®é¢˜ã€‚

## 3. gRPC ä¸ HTTP/2

å…¶å®å®˜æ–¹å¯¹æˆ‘æå‡ºçš„è¿™ä¸ªé—®é¢˜ç®—æ˜¯æœ‰æ‰€è§£ç­”çš„ã€‚

ä¸€æ˜¯åœ¨å…¶[å®˜æ–¹åšå®¢](https://developers.googleblog.com/2015/02/introducing-grpc-new-open-source-http2.html)ä¸Šã€‚HTTP/2 æ ‡å‡†å¸¦æ¥äº†è®¸å¤šå¥½å¤„ï¼Œæ¯”å¦‚åŒå‘æµã€æµæ§åˆ¶ã€é¦–éƒ¨å‹ç¼©ã€ä¸€æ¡ TCP è¿æ¥çš„å¤šè·¯å¤ç”¨ç­‰ã€‚è¿™äº›åŠŸèƒ½å¯ä»¥åœ¨å‡å°‘ç”µé‡å’Œæ•°æ®ä½¿ç”¨é‡ï¼ŒåŒæ—¶ä½¿å¾—äº‘åŸç”Ÿçš„æœåŠ¡å’Œ web åº”ç”¨æ›´å¿«ã€‚

> Building on HTTP/2 standards brings many capabilities such as bidirectional streaming, flow control, [header compression](http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-12), multiplexing requests over a single TCP connection and more. These features save battery life and data usage on mobile while speeding up services and web applications running in the cloud.

äºŒæ˜¯æœ‰äººåœ¨ GitHub ä¸Šæè¿‡æœ‰å…³è¯¥é—®é¢˜çš„ [Issue](https://github.com/grpc/grpc/issues/6292)ï¼Œå®˜æ–¹è§£ç­”è¡¨ç¤º HTTP2 æ˜¯ä¸šå†…æ ‡å‡†ï¼Œå¹¶ä¸” HTTP å¯¹ä»£ç†ã€é˜²ç«å¢™å’Œå…¶ä»–è½¯ä»¶éƒ½å¾ˆå‹å¥½ã€‚HTTP/2 çš„æµå¼ä¹Ÿå¾ˆé€‚åˆ gRPC çš„éœ€æ±‚ï¼Œå› æ­¤æ²¡å¿…è¦é‡æ–°é€ è½®å­ã€‚

> HTTP2 is used for many good reasons: HTTP2 is a standard and HTTP protocol is well known to proxies, firewalls and many software tools. The streaming nature of HTTP2 suits our needs very well, so no need to reinvent the wheel. We'll probably post more on this topic soon on grpc.io page.

è™½ç„¶ HTTP/2 æœ‰ç€ç§ç§ä¼˜åŠ¿ï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯è§‰å¾—å¦‚æœ gRPC è‡´åŠ›äºæˆä¸º**æœ€å¿«**çš„ RPC æ¡†æ¶ï¼Œé‚£ä¹ˆä¸€å®šä¸ä¼šé€‰æ‹©åŸºäº HTTP æ¥åšï¼Œå› ä¸ºé€šç”¨å°±æ„å‘³ç€å¦¥åï¼Œé‚£ä¹ˆå¿…ç„¶ä¸èƒ½æŠŠæ€§èƒ½å‘æŒ¥åˆ°æè‡´ã€‚è€Œè¿™äº› HTTP çš„ä¼˜åŠ¿å¦‚æœç”± Google è‡ªå·±å†å¦èµ·ç‚‰ç¶åšä¸€å¥—ï¼Œæˆ‘ç›¸ä¿¡ä¹Ÿä¸€å®šä¹Ÿéƒ½ä¸ä¼šé€Šè‰²ã€‚æ‰€ä»¥è¿™äº›å…¶å®å¹¶æ²¡æœ‰è¯´æœæˆ‘ã€‚ã€‚ğŸ˜… è€Œä¸”å¯èƒ½æ˜¯åœ¨å·¨ç¡¬å‘†ä¹…äº†ï¼Œæ€»è§‰å¾—ç”¨åˆ«äººçš„ä¸œè¥¿åœ¨åˆè§„æ€§ã€å®‰å…¨æ€§ç­‰æ–¹é¢éƒ½æœ‰æ‰€é™åˆ¶ä¸é¡¾è™‘ï¼Œæ€»å¾—è‡ªå·±å†é€ ä¸€éè½®å­æ‰æ”¾å¿ƒã€‚ã€‚ï¼ˆé€ƒ ğŸ˜µ

ä½†æ˜¯ï¼åœ¨æ·±å…¥ç ”ç©¶ HTTP/2ã€å›é¡¾ HTTP å‘å±•å†å²çš„æ—¶å€™ï¼Œæˆ‘å‘ç°å®ƒå…¶å®æ˜¯åŸºäº SPDY è€Œå®ç°çš„ï¼Œè€Œ SPDY æ­£æ˜¯ç”± Google å¼€æºçš„ï¼Œwhich means HTTP/2 å…¶å®å°±æ˜¯ Google åœ¨æ¨åŠ¨å•Šï¼ï¼åŒæ—¶ï¼Œæƒ³åˆ° HTTP/1.1 åœ¨ä¸šç•Œçš„æ”¯æŒå¹¶ä¸å¥½ï¼ŒGoogle ç€åŠ›äºæ¨å¹¿ HTTP/2 ä¹Ÿæ˜¯æ­£å¸¸ã€‚ç„¶åå°±å¼€å§‹åœ¨ç½‘ç»œä¸Šæœç´¢æ˜¯å¦æœ‰äººå¯¹æ­¤æœ‰ç±»ä¼¼çš„è§‚ç‚¹ï¼Œæœ€ååœ¨è¿™ç¯‡[å†™å¾—å¾ˆå¥½çš„æ–‡ç« ](https://segmentfault.com/a/1190000004399183)ï¼ˆä¹Ÿæ˜¯ä¸€ç¯‡å¯¹ HTTP å†å²æ•´ç†å¾—å¾ˆå¥½çš„æ–‡ç« ï¼‰ä¸­çœ‹åˆ°äº†ä»–çš„è§‚ç‚¹ã€‚å…¶å®æœ¬äººåœ¨äº’è”ç½‘ä¸Šå¹¶æ²¡æœ‰æœç´¢åˆ°ä»€ä¹ˆé˜´è°‹è®ºå‘è¨€ã€‚ã€‚ä¸è¿‡è¿™æ˜¾å¾—æˆ‘æœ‰ç‚¹å°äººä¹‹å¿ƒåº¦å›å­ä¹‹è…¹äº†ã€‚ã€‚ğŸ¥µ

> SPDY å’Œ HTTP/2 ä¹‹é—´çš„æš§æ˜§å…³ç³»ï¼Œä»¥åŠ Google ä½œä¸º SPDY çš„åˆ›é€ è€…ï¼Œè¿™ä¸¤ç‚¹å¾ˆå®¹æ˜“è®©é˜´è°‹è®ºè€…æ€€ç–‘ Google æ˜¯å¦ä¼šæˆä¸ºåè®®çš„æœ€ç»ˆæ”¶ç›Šæ–¹ã€‚è¿™å…¶å®æ˜¯åºŸè¯ï¼ŒGoogle å½“ç„¶ä¼šå—ç›Šï¼Œä»»ä½•æ–°åè®®ä½¿ç”¨è€…éƒ½ä¼šä»ä¸­å—ç›Šï¼Œè‡³äºè°åƒè‚‰ï¼Œè°å–æ±¤çœ‹çš„æ˜¯è‡ªå·±çš„æœ¬äº‹ã€‚ä»æ•´ä¸ªåè®®çš„å˜è¿å²ä¹Ÿå¯ä»¥ç²—ç•¥çœ‹å‡ºï¼Œæ–°åè®®çš„è¯ç”Ÿå®Œå…¨æ˜¯é’ˆå¯¹ä¸šç•Œç°å­˜é—®é¢˜å¯¹ç—‡ä¸‹è¯ï¼Œå¹¶æ²¡æœ‰ Google ä¸šåŠ¡ç›¸å…³çš„ç—•è¿¹å­˜åœ¨ï¼ŒGoogle è‡³å§‹è‡³ç»ˆåªæ‰®æ¼”äº†ä¸€ä¸ªè§’è‰²ï¼šyou can you upã€‚

Anywayï¼Œè¿™ä¹Ÿå†æ¬¡è¯´æ˜ï¼Œæœºä¼šæ˜¯ç•™ç»™æœ‰å‡†å¤‡çš„äººï¼ˆä¸è¦çªç„¶æ‹”é«˜ä»·å€¼è§‚å•Šå–‚ï¼‰ï¼Œè¿™ä¸€åˆ‡éƒ½æ˜¯åŸºäº HTTP/2 è¶³å¤Ÿä¼˜ç§€ï¼Œä¸ç„¶é€šè¿‡ gRPC æ¨å¹¿ HTTP/2 ä¹Ÿåªèƒ½ç°é£çƒŸç­ã€‚ä¸è¿‡ Google ä¸æƒ³åœ¨æœ¬èº«å°±æ˜¯ç”±è‡ªå·±è®¾è®¡å¹¶æ¨åŠ¨çš„ SPDY/(HTTP/2) ä¸Šé‡å¤é€ è½®å­ï¼Œä¹Ÿæ˜¯è‡ªç„¶çš„ã€‚ğŸ¤§

æ­¤æ—¶ï¼Œå›è¿‡å¤´æ¥å†çœ‹ gRPC çš„ [motivation](https://grpc.io/blog/principles/#motivation)ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒgRPC æ˜¯ç”±åŸæ¥ Google å†…éƒ¨çš„ä¸€ä¸ªåä¸º Stubby çš„é€šç”¨ RPC infra æ¼”å˜è€Œæ¥çš„ã€‚ç„¶è€Œï¼Œå®ƒä¸åŸºäºä»»ä½•æ ‡å‡†ï¼Œè€Œä¸”ä¸ Google çš„å†…éƒ¨åŸºç¡€è®¾æ–½ç»“åˆå¾—å¤ªè¿‡ç´§å¯†ï¼Œå› æ­¤è¢«è®¤ä¸ºä¸é€‚åˆå…¬å¼€å‘å¸ƒã€‚éšç€ SPDYã€HTTP/2 å’Œ QUIC çš„å‡ºç°ï¼Œè®¸å¤šç›¸åŒçš„åŠŸèƒ½å·²ç»å‡ºç°åœ¨å…¬å…±æ ‡å‡†ä¸­ï¼ŒåŒæ—¶è¿˜æœ‰ Stubby ä¸æä¾›çš„å…¶ä»–åŠŸèƒ½ã€‚æ‰€ä»¥ Google åœ¨ Stubby çš„åŸºç¡€ä¸Šè¿›è¡Œäº†é‡æ–°è®¾è®¡ï¼Œå¹¶åˆ©ç”¨è¿™äº›æ ‡å‡†è§„èŒƒå°†å…¶é€‚ç”¨æ€§æ‰©å±•åˆ°ç§»åŠ¨ã€ç‰©è”ç½‘å’Œäº‘è®¡ç®—çš„åº”ç”¨åœºåˆã€‚

> Google has been using a single general-purpose RPC infrastructure called Stubby to connect the large number of microservices running within and across our data centers for over a decade. Our internal systems have long embraced the microservice architecture gaining popularity today. Having a uniform, cross-platform RPC infrastructure has allowed for the rollout of fleet-wide improvements in efficiency, security, reliability and behavioral analysis critical to supporting the incredible growth seen in that period.
>
> Stubby has many great features - however, itâ€™s not based on any standard and is too tightly coupled to our internal infrastructure to be considered suitable for public release. With the advent of SPDY, HTTP/2, and QUIC, many of these same features have appeared in public standards, together with other features that Stubby does not provide. It became clear that it was time to rework Stubby to take advantage of this standardization, and to extend its applicability to mobile, IoT, and Cloud use-cases.

å› æ­¤ï¼ŒgRPC ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ HTTP/2 è¿™ä¸ªé—®é¢˜å…¶å®æœ¬è´¨ä¸Šæ˜¯åœ¨é—®é‡æ–°è®¾è®¡ Stubby æ—¶ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ SPDY/(HTTP/2)ã€‚ç­”æ¡ˆä¹Ÿéƒ½å†™æ¸…æ¥šäº†ï¼Œæ²¡å¼€æºçš„ Stubby æœ¬èº«å°±æ˜¯ä¸€ä¸ªé€šç”¨ general-purposeã€ç»Ÿä¸€ unifromã€è·¨å¹³å° cross-platform çš„ RPC infraï¼Œè€Œä¸”å…¶ä¸­å¾ˆå¤šè‡ªå·±é€ è½®å­çš„ã€ä¸èƒ½å…¬å¼€å‘å¸ƒçš„åŠŸèƒ½éƒ½å·²ç»è¢«æ ‡å‡† HTTP/2 å®ç°äº†ï¼Œæ‰€ä»¥ gRPC å°±é¡ºç†æˆç« ä½¿ç”¨ HTTP/2 äº†ã€‚

## 4. æ€»ç»“

1. HTTP/1.0 => HTTP/1.1ï¼šé»˜è®¤ä½¿ç”¨é•¿è¿æ¥ï¼Œä¸å¥½ç”¨çš„ã€è¢«é»˜è®¤å…³é—­çš„æµæ°´çº¿ pipeliningã€‚
2. HTTP/1.x => HTTP/2ï¼šé‡æ–°è¿›è¡Œå°è£…è®¾è®¡ä½†ä¸æ”¹å˜ HTTP è¯­ä¹‰ã€‚
3. HTTP/2 æ¥è‡ª SPDYï¼ŒgRPC æ¥è‡ª Stubbyã€‚

## å‚è€ƒ

- [Hypertext Transfer Protocol Version 2 (HTTP/2)](https://www.rfc-editor.org/rfc/rfc7540l)
- [HPACK: Header Compression for HTTP/2](https://www.rfc-editor.org/rfc/rfc7541l)
- [HTTP 2.0 çš„é‚£äº›äº‹](https://segmentfault.com/a/1190000004399183) / [HTTP/2 ç›¸æ¯” 1.0 æœ‰å“ªäº›é‡å¤§æ”¹è¿›ï¼Ÿ - victor yuçš„å›ç­” - çŸ¥ä¹](https://www.zhihu.com/question/34074946/answer/108588042)
- [CS-Notes HTTP](https://github.com/CyC2018/CS-Notes/blob/master/notes/HTTP.md)
- [MDN HTTP/1.x çš„è¿æ¥ç®¡ç†](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Connection_management_in_HTTP_1.x)
- [è¯¦è§£ HTTP/2 å¤´å‹ç¼©ç®—æ³• â€”â€” HPACK](https://halfrost.com/http2-header-compression/)
- [HTTP/2.0 Header Compressionï¼ˆä¸‹ï¼‰](https://laoqingcai.com/http2-headercompression2/index.html)
- [HTTP/2.0 Flow Control](https://laoqingcai.com/http2-flowcontrol/)
- [HTTP/2.0 Stream Priority](https://laoqingcai.com/http2-streampriority/)
- [å…³äºé˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line blockingï¼‰ï¼Œçœ‹è¿™ä¸€ç¯‡å°±è¶³å¤Ÿäº†](https://zhuanlan.zhihu.com/p/330300133)

