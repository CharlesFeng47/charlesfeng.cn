---
date: 2020-05-13
title: 'é…ç½® SSL/TLS çš„ä¸€ç‚¹è®°å½•'
template: post
thumbnail: '../thumbnails/qualys.png'
slug: ssl-conf
categories:
  - Tech
tags:
  - HTTPS
  - SSL/TLS
  - Nginx
  - SNI
  - CDN
---

## å†™åœ¨å‰é¢

ä½¿ç”¨ [Let's Encrypt](https://letsencrypt.org/zh-cn/) æ¥è·å–å…è´¹çš„è¯ä¹¦ä»¥è¿›è¡Œ Nginx çš„ HTTPS é…ç½®å·²ç»æ˜¯ä¸€ä¸ªå¾ˆæˆç†Ÿçš„æ€è·¯ï¼Œæ‰€ä»¥æˆ‘çŒœæƒ³è‡ªå·±çš„é…ç½®è·¯ä¹Ÿä¸€å®šé¡ºé¡ºåˆ©åˆ©...ç„¶é¹…äº‹æƒ…æ€»æ˜¯æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œæˆ‘è¿˜æ˜¯ç¢°åˆ°äº†ä¸€ç‚¹å°é—®é¢˜ï¼Œå°±è®°å½•ä¸€ä¸‹å­ğŸ˜˜ã€‚

## é…ç½®æ€è·¯

æˆ‘çš„æœåŠ¡å™¨ OS æ˜¯ CentOS 7ï¼Œ[å®˜ç½‘](https://certbot.eff.org/lets-encrypt/centosrhel7-nginx.html)è¯´å¾—æ¸…æ¥šæ˜äº†ï¼Œæœ‰ä¸æ‡‚å¯ä»¥å†å‚è€ƒè¿™ç¯‡[åšå®¢](https://pylixm.cc/posts/2019-08-12-letencrypt.html)çš„è®²è§£ï¼Œå¾ˆè¯¦ç»†ã€‚ï¼ˆ~~æ‰€ä»¥æ‘˜æŠ„åœ¨ä¸‹é¢~~ï¼‰

>#### å®‰è£…ç›¸å…³å·¥å…·
>
>```shell
>yum install -y certbot 
>yum install -y python2-certbot-nginx
>```
>
>certbot æ˜¯ Let's Encrypt æä¾›çš„ä¸€ä¸ªè‡ªåŠ¨åŒ–ç”Ÿæˆè¯ä¹¦å·¥å…·ï¼Œpython2-certbot-nginx åˆ™æ˜¯ä¸º certbot æä¾›è‡ªåŠ¨æ“ä½œ Nginx é…ç½®æ–‡ä»¶çš„å·¥å…·ã€‚
>
>####è·å–è¯ä¹¦
>
>##### å®‰è£…ç‰ˆ Nginx
>
>è‹¥ä½ çš„ Nginx æ˜¯é€šè¿‡ yum æˆ– rpm åŒ…çš„æ–¹å¼å®‰è£…ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ç§æ–¹å¼çš„å‘½ä»¤æ¥è‡ªåŠ¨ç”Ÿæˆè¯ä¹¦ã€‚æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ° urllib3 çš„å¼‚å¸¸ï¼ŒåŸå› æ˜¯ Python æ¨¡å—ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œéœ€è¦é‡è£…ç›¸åº”åŒ…ï¼Œå…·ä½“è¯·å‚è§[è¿™é‡Œ](https://pylixm.cc/posts/2019-08-12-letencrypt.html#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6)ã€‚
>
>1. ç”Ÿæˆè¯ä¹¦å¹¶è‡ªåŠ¨ä¿®æ”¹ Nginx é…ç½®ã€‚
>
>```shell
>certbot --nginx certbot --nginx rollback # å›æ»šé…ç½®
>```
>
>2. åªç”Ÿæˆè¯ä¹¦ï¼Œä¸ä¿®æ”¹ Nginx é…ç½®ã€‚
>
>```shell
>certbot certonly --nginx
>```
>
>##### æºç ç‰ˆ Nginx
>
>è‹¥ä½ ä½¿ç”¨çš„æ˜¯æ— éœ€å®‰è£…çš„æºç ç‰ˆï¼Œåˆ™å¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è·å–è¯ä¹¦ã€‚
>
>```shell
>mkdir -p /var/www/example
>certbot certonly --webroot -w /var/www/example -d example.com -d www.example.com
>```
>
>`--webroot` æ¨¡å¼ä¼šåœ¨ /var/www/example ä¸­åˆ›å»º .well-known æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹é‡Œé¢åŒ…å«äº†ä¸€äº›éªŒè¯æ–‡ä»¶ï¼Œcertbot ä¼šé€šè¿‡è®¿é—® `example.com/.well-known/acme-challenge` æ¥éªŒè¯ä½ çš„åŸŸåæ˜¯å¦ç»‘å®šçš„è¿™ä¸ªæœåŠ¡å™¨ã€‚ä»¥ç¡®å®šä½ å¯¹è¯¥åŸŸåçš„æ‹¥æœ‰æƒã€‚
>
>`--nginx` æ¨¡å¼æ—¶ï¼Œè¯¥éªŒè¯ä¼šè‡ªåŠ¨é€šè¿‡ Nginx çš„æœåŠ¡æ¥å®ç°ã€‚
>
>è¿™ç§éªŒè¯æ–¹å¼ï¼ŒLetæœºæ„å«åš [ACMEåè®®](https://link.jianshu.com/?t=https://ietf-wg-acme.github.io/acme/)ã€‚åªè¦éµå¾ªè¯¥åè®®ï¼Œå°±å¯ä»¥è·å–Letç»“æ„ç­¾å‘çš„è¯ä¹¦ã€‚é™¤äº†å®˜æ–¹çš„certbotå·¥å…·å¤–ï¼Œä¹Ÿæœ‰å¾ˆå¤šéµå¾ª ACMEåè®®çš„ç¬¬ä¸‰æ–¹è‡ªåŠ¨åŒ–å·¥å…·ï¼Œå¦‚ [acme.sh](https://github.com/Neilpang/acme.sh)ã€‚

å¯¹æˆ‘è€Œè¨€ï¼Œå› ä¸ºæƒ³è·å–å®˜æ–¹çš„é€šçŸ¥ï¼ˆå¦‚è¯ä¹¦è¿‡æœŸæé†’ç­‰ï¼‰ï¼Œæ‰€ä»¥åŠ ä¸Šäº† `--email` å‚æ•°ï¼Œå¦‚ä¸‹ã€‚

```shell
certbot certonly --email fdfengjunjie@126.com --webroot -w /data/charlesfeng/blog -d charlesfeng.cn
```

æœ€åï¼Œé…ç½®ä¸‹å®šæ—¶ä»»åŠ¡ï¼Œå°†ç»“æœé‡å®šå‘è‡³æŸä¸ªæ–‡ä»¶ï¼Œä»¥ä¾¿æ—¥å debugã€‚

```shell
15 3 * * * /usr/bin/certbot renew > /data/letsencrypt.update.log 2>&1
```

## é…ç½® Nginx

å› ä¸ºæˆ‘æ˜¯æºç ç‰ˆï¼Œæ‰€ä»¥å¾—è‡ªå·±ä¿®æ”¹ Nginx æ–‡ä»¶ã€‚Mozilla æä¾›äº†ä¸€ä¸ª SSL é…ç½®æ–‡ä»¶çš„[ç”Ÿæˆå™¨](https://ssl-config.mozilla.org/#server=nginx&version=1.12.2&config=intermediate&openssl=1.1.1d&guideline=5.4)ï¼Œç‰¹åˆ«æ£’ï¼ç„¶åé…ç½®å…¶å®ä¹Ÿæ²¡å•¥ç‰¹åˆ«çš„ï¼Œä¸»è¦å°±æ˜¯åœ¨ CDN åŸŸå cdn.charlesfeng.cn ä¸Šè¸©äº†ä¸€ä¸‹å‘ã€‚ğŸ¥¶

#### CDN çš„å‘

å› ä¸ºæˆ‘æœ‰ä¸¤ä¸ªåŸŸåå˜›ï¼Œä¸€ä¸ªæ˜¯åšå®¢çš„ charlesfeng.cnï¼Œä¸€ä¸ªæ˜¯é˜¿é‡Œäº‘ CDN çš„åŠ é€ŸåŸŸå cdn.charlesfeng.topï¼ŒCDN åŠ é€ŸåŸŸåä¹‹å‰æ˜¯é˜¿é‡Œäº‘å¸®å¿™ä¸Šçš„ HTTPSï¼Œæ‰€ä»¥æˆ‘å°±å…ˆå–æ¶ˆäº†ï¼Œæƒ³ç€è‡ªå·±é…ã€‚ç»“æœæ€ä¹ˆéƒ½ä¸æˆåŠŸ...åæ¥åœ¨ [SSL Lab](https://www.ssllabs.com/ssltest/) æµ‹äº†ä¸‹ï¼Œç»“æœå¦‚ä¸‹å›¾ã€‚

![](https://images.charlesfeng.cn/2020-05-13-ssllab-cdn.jpg)

çœ‹åˆ°æˆ‘åˆ’çº¿çš„éƒ¨åˆ†ï¼Œæ‰ååº”è¿‡æ¥ CDN åŸŸåæ˜¯ç›´æ¥è§£æåˆ°é˜¿é‡Œäº‘çš„ CDN èŠ‚ç‚¹ï¼ˆå¦‚ä¸Šå›¾çš„ 47.246.23.105ï¼‰ä¸Šçš„ï¼Œè¯¥èŠ‚ç‚¹ä¸Šæ‰¾ä¸åˆ°å›æºæ—¶æ‰ä¼šåˆ°æˆ‘çš„æœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—åœ¨é˜¿é‡Œäº‘ CDN ç•Œé¢ä¸Šé…ç½® HTTPSï¼Œä¿è¯æ™®é€šç”¨æˆ·å’Œé˜¿é‡Œäº‘ CDN èŠ‚ç‚¹é—´æ˜¯ HTTPSï¼Œè€Œå›æºæ—¶é‡‡å–çš„åè®®å¯å‚è€ƒ[ç›¸å…³æ–‡æ¡£](https://help.aliyun.com/document_detail/34949.html)ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œå› ä¸ºç”³è¯·äº† cdn.charlesfeng.top çš„è¯ä¹¦ï¼Œæ‰€ä»¥å°±ç›´æ¥å…¨å‘˜ä¸Š HTTPS äº†ã€‚ï¼ˆ~~å…¶å®æ˜¯ revoke ååˆç”³è¯·çš„~~ğŸ¤ï¼‰

![](https://images.charlesfeng.cn/2020-05-13-arch.png)

æ­¤å¤–ï¼Œ[ä¸Šæ–‡](status-code-307-and-hsts)è¯´åˆ° HSTS æœ‰ä¸€ä¸ªä¸è¶³â€”â€”ã€Œç”¨æˆ·é¦–æ¬¡è®¿é—®æŸç½‘ç«™æ˜¯ä¸å— HSTS ä¿æŠ¤çš„ã€ï¼Œè¿™å¯ä»¥é€šè¿‡ Nginx å°† HTTP è¯·æ±‚è½¬å‘åˆ° HTTPS ä¸Šæ¥å¼¥è¡¥ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘åœ¨ conf.d/ ç›®å½•ä¸‹æ–°å»ºäº†ä¸€ä¸ªæ–‡ä»¶ forcehttp.confï¼Œé…ç½®å¦‚ä¸‹ã€‚

```shell
server {
	listen 80;
	server_name charlesfeng.cn cdn.charlesfeng.top;
	return 301 https://$host$request_uri;
}
```

#### SSL Lab æµ‹è¯•ç»“æœ

æœ€å¼€å§‹æ²¡æœ‰é… HSTS å’Œ OCSPï¼Œç„¶åè¯„åˆ†åªå¾—äº† Aï¼Œåæ¥é…ä¸Š HSTS åï¼Œè¯„åˆ†å˜ä¸º A+ğŸ¥³ã€‚OCSP çš„ç®€ä»‹å¦‚ä¸‹ï¼Œæˆ‘æ„Ÿè§‰æ²¡æœ‰å¤ªå¤§å¿…è¦ï¼Œå°±æ²¡é…äº†ã€‚

>**OCSP è£…è®¢**ï¼ˆè‹±è¯­ï¼šOCSP Staplingï¼‰ï¼Œæ­£å¼åç§°ä¸º [TLS](https://zh.wikipedia.org/wiki/å‚³è¼¸å±¤å®‰å…¨å”è­°)[è¯ä¹¦](https://zh.wikipedia.org/wiki/æ•°å­—è¯ä¹¦) çŠ¶æ€æŸ¥è¯¢æ‰©å±•ï¼Œå¯ä»£æ›¿[åœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®](https://zh.wikipedia.org/wiki/åœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®)ï¼ˆOCSPï¼‰æ¥æŸ¥è¯¢ [X.509](https://zh.wikipedia.org/wiki/X.509) è¯ä¹¦çš„çŠ¶æ€ã€‚æœåŠ¡å™¨åœ¨ TLS æ¡æ‰‹æ—¶å‘é€äº‹å…ˆç¼“å­˜çš„ OCSP å“åº”ï¼Œç”¨æˆ·åªéœ€éªŒè¯è¯¥å“åº”çš„æœ‰æ•ˆæ€§è€Œä¸ç”¨å†å‘[æ•°å­—è¯ä¹¦è®¤è¯æœºæ„](https://zh.wikipedia.org/wiki/æ•°å­—è¯ä¹¦è®¤è¯æœºæ„)ï¼ˆCAï¼‰å‘é€è¯·æ±‚ã€‚

![](https://images.charlesfeng.cn/2020-05-13-ssllab-domain.jpg)

è™½ç„¶è¯„çº§ä¸º A+ äº†ï¼Œä½†æ˜¯æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸€å¥è¯ã€ŒThis site works only in browsers with SNI supportã€ï¼Œä¸”æµ‹è¯•ä¸­æ”¶åˆ°äº†ä¸¤ä¸ªè¯ä¹¦ï¼ˆç†æƒ³æƒ…å†µåº”è¯¥ä¸ºä¸€ä¸ªï¼‰ï¼Œç¬¬äºŒä¸ªè¯ä¹¦ä¸æ˜¯æœ¬åŸŸåçš„å¹¶æ ‡å¿—ã€ŒNo SNIã€ã€‚æ‰€ä»¥å¥½å¥‡ç€ç»§ç»­çœ‹çœ‹å§ã€‚

> **SNI æœåŠ¡å™¨åç§°æŒ‡ç¤º**ï¼ˆè‹±è¯­ï¼š**S**erver **N**ame **I**ndicationï¼Œç¼©å†™ï¼š**SNI**ï¼‰æ˜¯ [TLS](https://zh.wikipedia.org/wiki/TLS) çš„ä¸€ä¸ªæ‰©å±•åè®®ï¼Œåœ¨è¯¥åè®®ä¸‹ï¼Œåœ¨[æ¡æ‰‹](https://zh.wikipedia.org/wiki/æ¡æ‰‹_(æŠ€æœ¯))è¿‡ç¨‹å¼€å§‹æ—¶[å®¢æˆ·ç«¯](https://zh.wikipedia.org/wiki/å®¢æˆ·ç«¯)å‘Šè¯‰å®ƒæ­£åœ¨è¿æ¥çš„[æœåŠ¡å™¨](https://zh.wikipedia.org/wiki/æœåŠ¡å™¨)è¦è¿æ¥çš„[ä¸»æœºåç§°](https://zh.wikipedia.org/wiki/ä¸»æ©Ÿåç¨±)ã€‚è¿™å…è®¸æœåŠ¡å™¨åœ¨ç›¸åŒçš„ [IP åœ°å€](https://zh.wikipedia.org/wiki/IPåœ°å€) å’Œ [TCP ç«¯å£å·](https://zh.wikipedia.org/wiki/é€šè¨ŠåŸ ) ä¸Šå‘ˆç°å¤šä¸ª[è¯ä¹¦](https://zh.wikipedia.org/wiki/é›»å­æ†‘è­‰)ï¼Œå¹¶ä¸”å› æ­¤å…è®¸åœ¨ç›¸åŒçš„ IP åœ°å€ä¸Šæä¾›å¤šä¸ªå®‰å…¨ï¼ˆ[HTTPS](https://zh.wikipedia.org/wiki/è¶…æ–‡æœ¬ä¼ è¾“å®‰å…¨åè®®)ï¼‰ç½‘ç«™ï¼ˆæˆ–å…¶ä»–ä»»ä½•åŸºäº TLS çš„[æœåŠ¡](https://zh.wikipedia.org/wiki/æœåŠ¡å™¨)ï¼‰ï¼Œè€Œä¸éœ€è¦æ‰€æœ‰è¿™äº›ç«™ç‚¹ä½¿ç”¨ç›¸åŒçš„è¯ä¹¦ã€‚å®ƒä¸ HTTP/1.1 åŸºäºåç§°çš„[è™šæ‹Ÿä¸»æœº](https://zh.wikipedia.org/wiki/è™šæ‹Ÿä¸»æœº)çš„æ¦‚å¿µç›¸åŒï¼Œä½†æ˜¯ç”¨äº HTTPSã€‚æ‰€éœ€çš„ä¸»æœºåæœªåŠ å¯†ï¼Œå› æ­¤çªƒå¬è€…å¯ä»¥æŸ¥çœ‹è¯·æ±‚çš„ç½‘ç«™ã€‚

è¿™ä¸ªé—®é¢˜åœ¨[è¿™é‡Œ](https://github.com/ssllabs/ssllabs-scan/issues/476#issuecomment-290305264)æ‰¾åˆ°äº†ç­”æ¡ˆï¼Œå½“ä¸å¯ç”¨ SNI è¿›è¡Œ TLS è¿æ¥æ—¶ï¼ŒSSL Lab æ”¶åˆ°äº†æˆ‘çš„ç¬¬äºŒä¸ªè¯ä¹¦ï¼Œåªæœ‰éå¸¸è€æ—§çš„å®¢æˆ·ç«¯æ‰ä¼šç¢°åˆ°æ­¤æƒ…å†µï¼Œè€Œå½“ä»Š**æ‰€æœ‰ç°ä»£æµè§ˆå™¨**éƒ½æ”¯æŒ SNIï¼Œæ‰€ä»¥å¦‚æœä½ ä¸æ˜¯çœŸçš„å¾ˆå…³å¿ƒåœ¨è€æ—§æµè§ˆå™¨ï¼ˆå¦‚ IE 6 / XPã€IE 8 / XPã€Java 6u45ã€Android 2.3.7ï¼‰ä¸Šçš„å·¥ä½œæƒ…å†µï¼Œå¯ä»¥å¿½ç•¥ç¬¬äºŒä¸ªè¯ä¹¦ã€‚ï¼ˆ~~åˆ«é—®ï¼Œé—®å°±æ˜¯ A+~~ï¼‰

## å‚è€ƒ

- [certbot instructions: Nginx on CentOS/RHEL 7](https://certbot.eff.org/lets-encrypt/centosrhel7-nginx.html)

- [ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦å®ç° Nginx ç«™ç‚¹çš„ HTTPS åŒ–](https://pylixm.cc/posts/2019-08-12-letencrypt.html)

- [SSL Configuration Generator](https://ssl-config.mozilla.org/#server=nginx&version=1.12.2&config=intermediate&openssl=1.1.1d&guideline=5.4)

- [How To Secure Nginx with Let's Encrypt on CentOS 7](https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-centos-7)

- [Let's Encrypt åŠé”€è¯ä¹¦](https://letsencrypt.org/zh-cn/docs/revoking/)

- [é˜¿é‡Œäº‘ CDN é…ç½®å›æºåè®®](https://help.aliyun.com/document_detail/34949.html)

- [WIKI OCSP è£…è®¢](https://zh.wikipedia.org/wiki/OCSP%E8%A3%85%E8%AE%A2)

- [WIKI SNI](https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E6%8C%87%E7%A4%BA)

- [Secondary SSL cert #476](https://github.com/ssllabs/ssllabs-scan/issues/476#issuecomment-290305264)

- [Second certificate in SSL Test and no SNI support](https://community.letsencrypt.org/t/second-certificate-in-ssl-test-and-no-sni-support/115552/3)

