---
date: 2020-05-12
title: 'HTTPS -> HTTP å¼•èµ·çš„ 307 çŠ¶æ€ç ä¸ HSTS'
template: post
thumbnail: '../thumbnails/https.png'
slug: status-code-307-and-hsts
categories:
  - Tech
tags:
  - HTTPS
  - Web
  - DevOps
---

## é—®é¢˜èƒŒæ™¯

[å‰æ–‡](/transfer-from-netlify-to-my-aliyun-server)è¯´åˆ°å› ä¸º Netlify åœ¨å¢ƒå¤–ï¼Œè®¿é—®é€Ÿåº¦ä¸å¤ªç†æƒ³ï¼Œæ‰€ä»¥è¿ç§»åˆ°äº†é˜¿é‡Œäº‘ã€‚åˆå› ä¸ºä¹‹å‰åœ¨ Netlify æ—¶ï¼Œä¸€é”®å¯ç”¨ HTTPSï¼ˆå†æ¬¡æ€€å¿µğŸ¥ºï¼‰ï¼Œæ‰€ä»¥å°±æ²¡æœ‰æ‰‹åŠ¨é…ç½®ç›¸å…³è¯ä¹¦ã€‚è€Œåœ¨åŸŸå charlesfeng.cn å¤‡æ¡ˆä¸‹æ¥åï¼Œæˆ‘ç€æ‰‹å°†å…¶è§£æåˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œå®Œæˆå‰æ–‡çš„å‰©ä½™å·¥ä½œã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘åªéœ€è¦åœ¨é˜¿é‡Œäº‘ DNS äº‘è§£æä¸Šæ·»åŠ ç›¸åº”çš„ A è§£æåˆ°å¯¹åº” ipï¼Œç„¶ååœ¨æœåŠ¡å™¨ä¸Šå¯ç”¨ Let's Encrypt çš„å…è´¹è¯ä¹¦å°±å®Œæˆã€‚

ä½†æ˜¯ï¼Œç†æƒ³å¾ˆä¸°æ»¡ï¼Œç°å®å¾ˆæ®‹é…·ï¼Œåœ¨æ·»åŠ å¯¹åº” DNS Record åæˆ‘é€šè¿‡æµè§ˆå™¨å§‹ç»ˆæ— æ³•è®¿é—®ç½‘é¡µã€‚æœ€å¼€å§‹è®¤ä¸ºæ˜¯ DNS è¿˜æœªç”Ÿæ•ˆï¼Œä½†æ˜¯åæ¥åˆ†é’Ÿåå¯ä»¥é€šè¿‡åŸŸå ping åˆ°å¯¹åº” ipï¼Œè€Œæµè§ˆå™¨ä»ç„¶æ— æ³•è®¿é—®ï¼Œå°±å¾ˆå¥‡æ€ªäº†ã€‚Chrome å’Œ Safari è¡Œä¸ºç›¸åŒï¼Œæ‰€ä»¥ä¸‹æ–‡å‡ä»¥ Chrome ä¸ºä¾‹è®²è§£ã€‚

## debug æ€è·¯

#### DNS Record æœªç”Ÿæ•ˆ

é¦–å…ˆæ’é™¤æ­¤æ€è·¯ï¼Œå› ä¸ºå¦‚ä¸‹å›¾æˆ‘å·²ç»å¯ä»¥ ping åˆ°äº†ï¼Œè¯´æ˜ DNS Resolver å·²ç»åŒæ­¥äº†å¯¹åº”è®°å½•ã€‚å¦‚æœéœ€è¦å¤ä¹  DNS çš„è§£æè¿‡ç¨‹å¯å‚è€ƒ[è¿™é‡Œ](/dns-resolve)ã€‚

![](https://cdn.charlesfeng.top/images/2020-05-12-ping-domain.png)

#### æµè§ˆå™¨çš„è‡ªèº«ç¼“å­˜

å…¶æ¬¡ï¼Œæ€€ç–‘æ˜¯ Chrome æµè§ˆå™¨è‡ªèº«ç¼“å­˜äº† DNS Recordï¼Œæ‰€ä»¥è§£æåˆ°åŸå…ˆ Netlify çš„åŸŸå charlesfeng.netlify.app ä¸Šå»äº†ï¼Œä½†æ˜¯è¿™æœ‰ä¸¤ä¸ªä¸åˆç†ç‚¹ã€‚

1. å°±ç®—è§£æåˆ°åŸå…ˆ Netlify çš„åŸŸåï¼Œé‚£ä¹ˆæˆ‘ Netlify çš„åŸŸåä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸è®¿é—®çš„ã€‚
2. æ—¢ç„¶ç¼“å­˜äº†ï¼Œé‚£ä¹ˆå°±æŠŠç¼“å­˜æ¸…æ‰ã€‚ï¼ˆä¸è¿‡æˆ‘éƒ½åˆ·æ–° N æ¬¡äº†ï¼ŒChrome è¿˜ä¸å»æ›´æ–°ä¸‹å—ï¼Ÿè¿™æ ·æ„Ÿè§‰å¾ˆä¸ç§‘å­¦ã€‚ï¼‰äºæ˜¯ï¼ŒæŸ¥æ‰¾èµ„æ–™ï¼Œé€šè¿‡ `chrome://net-internals/#dns` æ¸…æ¥šäº†ç¼“å­˜ï¼Œstill not workingã€‚

#### Cookie

æ­¤æ—¶ï¼Œæˆ‘çªç„¶ç¦ä¸´å¿ƒè‡³ï¼Œæ‰“å¼€æ— ç—•æ¨¡å¼å°è¯•è®¿é—®ï¼Œç»“æœæˆåŠŸäº†ï¼ˆè¿™å°±å¾ˆè¿·ğŸ¥±ï¼‰ã€‚åŒä¸€å°æœºå™¨çš„ Chrome æ˜¯å¦æ— ç—•æ¨¡å¼è¿˜èƒ½æœ‰ä¸¤ç§æ“ä½œ...å°è±¡ä¸­ï¼Œæ— ç—•æ¨¡å¼ä¸æ˜¯åªæ˜¯ä¸æºå¸¦ Cookie ä¹‹ç±»çš„å—ï¼Ÿè·Ÿèƒ½ä¸èƒ½è®¿é—®åšå®¢æœ‰ä»€ä¹ˆå…³ç³»...ä¸è¿‡è¿˜æ˜¯å°è¯•æ¸…é™¤ Cookieï¼Œæ„æ–™ä¹‹ä¸­ä¸èµ·ä½œç”¨ğŸ¥¶

#### æ§åˆ¶å°

æœ€åï¼Œæˆ‘ç»ˆäºæƒ³èµ·æ¥çœ‹ Chrome æ§åˆ¶å°äº†...ç»“æœå¦‚ä¸‹å›¾ã€‚ï¼ˆè¿˜æ˜¯ä¸å¤Ÿæœ‰ç›´è§‰å•Š 555ï¼Œæˆ‘ä¸æ˜¯ä¸€ä¸ªåˆæ ¼çš„ç¨‹åºå‘˜ğŸ˜¤ï¼‰

![](https://cdn.charlesfeng.top/images/2020-05-12-1-http.png)

![](https://cdn.charlesfeng.top/images/2020-05-12-2-https.png)

å¯ä»¥çœ‹åˆ°ï¼Œå½“è¾“å…¥åŸŸå http://charlesfeng.cn åï¼Œé¦–å…ˆè¿”å›äº† 307 çŠ¶æ€ç ï¼Œé‡å®šå‘åˆ° https://charlesfeng.cnï¼Œè€Œæˆ‘ç›®å‰è¿˜æ²¡æœ‰é…ç½® SSL è¯ä¹¦ï¼Œæ‰€ä»¥è‡ªç„¶æ— æ³•å®‰å…¨è®¿é—®ã€‚

å› æ­¤ï¼Œé—®é¢˜æ˜ç¡®ã€‚

## HSTS

è§‚å¯Ÿåˆ°ä¸Šå›¾ HTTP è½¬å‘å¤„æœ‰ Headerâ€”â€”`Non-Authoritative-Reason : HSTS`ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ HSTS æ˜¯ä»€ä¹ˆã€‚ä¸‹é¢æ˜¯æ¥è‡ª MDN çš„[ç›¸å…³ä»‹ç»](https://developer.mozilla.org/zh-CN/docs/Glossary/HSTS)ã€‚

> HSTS ï¼ˆè‹±è¯­ï¼š**H**TTP **S**trict **T**ransport **S**ecurityï¼ŒHTTP ä¸¥æ ¼ä¼ è¾“å®‰å…¨ï¼‰è®©ç½‘ç«™å¯ä»¥é€šçŸ¥æµè§ˆå™¨å®ƒä¸åº”è¯¥å†ä½¿ç”¨ HTTP åŠ è½½è¯¥ç½‘ç«™ï¼Œè€Œæ˜¯è‡ªåŠ¨è½¬æ¢è¯¥ç½‘ç«™çš„æ‰€æœ‰çš„HTTPé“¾æ¥è‡³æ›´å®‰å…¨çš„ HTTPSã€‚å®ƒåŒ…å«åœ¨ HTTP çš„åè®®å¤´ [`Strict-Transport-Security`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Strict-Transport-Security) ä¸­ï¼Œåœ¨æœåŠ¡å™¨è¿”å›èµ„æºæ—¶å¸¦ä¸Šã€‚
>
> æ¢å¥è¯è¯´ï¼Œå®ƒå‘Šè¯‰æµè§ˆå™¨å°† URL åè®®ä» HTTP æ›´æ”¹ä¸º HTTPSï¼ˆä¼šæ›´å®‰å…¨ï¼‰ï¼Œå¹¶è¦æ±‚æµè§ˆå™¨å¯¹æ¯ä¸ªè¯·æ±‚æ‰§è¡Œæ­¤æ“ä½œã€‚

æ‰€ä»¥ï¼ŒçŒœæµ‹æ˜¯ Netlify è‡ªåŠ¨åœ¨å“åº”ä¸­è®¾ç½®äº† HSTSï¼Œä»è€Œå¯¼è‡´æˆ‘è¿™ä¸ªåŸŸåè¢«å¼ºåˆ¶è·³è½¬ HTTPS äº†ã€‚

è®¿é—®æˆ‘çš„å¦ä¸€ä¸ªåŸŸå cuihuaergou.top éªŒè¯ä¸‹ã€‚ï¼ˆå¯¹ï¼Œæˆ‘çš„åŸŸåå°±æ˜¯è¿™ä¹ˆå¤šğŸ¥°ï¼‰å¯ä»¥çœ‹åˆ°ç¡®å®åœ¨å“åº”ä¸­è®¾ç½®äº† `Strict-Transport-Security` å­—æ®µï¼Œ`max-age=31536000` è¡¨ç¤ºè‡ªåŠ¨ä½¿ç”¨ HTTPS è¿æ¥çš„æ—¶é—´ä¸ºä¸€å¹´ã€‚ï¼ˆè™½ç„¶å®³æˆ‘è¿™é‡ŒæŸ¥äº†ä¼šå„¿èµ„æ–™ï¼Œä½†æ˜¯ Netlify è¿™åŠŸèƒ½ä¹Ÿå¤ªå¥½äº†å­ğŸ˜­ï¼Œå­¦ä¹ äº†å­¦ä¹ äº†ï¼‰

![](https://cdn.charlesfeng.top/images/2020-05-12-reponse-hsts.jpg)

è¯¦ç»†çš„ `Strict-Transport-Security` å¯ä»¥å‚è§ MDN çš„[ç›¸å…³è¯´æ˜](https://developer.mozilla.org/zh-CN/docs/Security/HTTP_Strict_Transport_Security)ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯éåŠ å¯†ä¼ è¾“ï¼ˆå³ HTTPï¼‰æ—¶è®¾ç½®çš„ HSTS å­—æ®µæ— æ•ˆï¼Œ `Strict-Transport-Security` å­—æ®µä¼šè¢«æµè§ˆå™¨**å¿½ç•¥**ã€‚ï¼ˆå› ä¸ºæ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸­é—´äººæ”»å‡»çš„æ–¹å¼åœ¨è¿æ¥ä¸­ä¿®æ”¹ã€æ³¨å…¥æˆ–åˆ é™¤å®ƒã€‚åªæœ‰åœ¨ä½ çš„ç½‘ç«™é€šè¿‡ HTTPS è®¿é—®å¹¶ä¸”æ²¡æœ‰è¯ä¹¦é”™è¯¯æ—¶ï¼Œæµè§ˆå™¨æ‰è®¤ä¸ºä½ çš„ç½‘ç«™æ”¯æŒ HTTPS ç„¶åä½¿ç”¨ `Strict-Transport-Security` çš„å€¼ã€‚ï¼‰

ä¸‹é¢è®°å½•ä¸‹æµè§ˆå™¨å¦‚ä½•å¤„ç†çš„ã€‚

> ä½ çš„ç½‘ç«™ç¬¬ä¸€æ¬¡é€šè¿‡ HTTPS è¯·æ±‚ï¼ŒæœåŠ¡å™¨å“åº” `Strict-Transport-Security` å¤´ï¼Œæµè§ˆå™¨è®°å½•ä¸‹è¿™äº›ä¿¡æ¯ï¼Œç„¶ååé¢å°è¯•è®¿é—®è¿™ä¸ªç½‘ç«™çš„è¯·æ±‚éƒ½ä¼šè‡ªåŠ¨æŠŠ HTTP æ›¿æ¢ä¸º HTTPSã€‚
>
> å½“ HSTS å¤´è®¾ç½®çš„è¿‡æœŸæ—¶é—´åˆ°äº†ï¼Œåé¢é€šè¿‡ HTTP çš„è®¿é—®æ¢å¤åˆ°æ­£å¸¸æ¨¡å¼ï¼Œä¸ä¼šå†è‡ªåŠ¨è·³è½¬åˆ° HTTPSã€‚
>
> æ¯æ¬¡æµè§ˆå™¨æ¥æ”¶åˆ° Strict-Transport-Security å¤´ï¼Œå®ƒéƒ½ä¼šæ›´æ–°è¿™ä¸ªç½‘ç«™çš„è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥ç½‘ç«™å¯ä»¥åˆ·æ–°è¿™äº›ä¿¡æ¯ï¼Œé˜²æ­¢è¿‡æœŸå‘ç”Ÿã€‚
>
> Chromeã€Firefox ç­‰æµè§ˆå™¨é‡Œï¼Œå½“æ‚¨å°è¯•è®¿é—®è¯¥åŸŸåä¸‹çš„å†…å®¹æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª 307 Internal Redirectï¼ˆå†…éƒ¨è·³è½¬ï¼‰ï¼Œè‡ªåŠ¨è·³è½¬åˆ° HTTPS è¯·æ±‚ã€‚

æ³¨æ„æœ€åä¸€æ®µè¯ï¼ŒChrome è®¿é—®è¯¥åŸŸåæ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª 307 çš„å†…éƒ¨è·³è½¬ï¼Œå¹¶è‡ªåŠ¨é‡å®šå‘åˆ°è¯¥åœ°å€çš„ HTTPS ç‰ˆæœ¬ã€‚**è¿™ä¸ª 307 å“åº”æ˜¯è™šå‡çš„ï¼ˆdummyï¼‰**ï¼Œè€ŒéæœåŠ¡å™¨ç”Ÿæˆçš„â€”â€”å³ Chrome æ˜¯å…ˆåœ¨**å†…éƒ¨**è¿›è¡Œäº†æ­¤æ“ä½œï¼Œï¼ˆæ³¨æ„æ­¤ 307 çŠ¶æ€ç çš„æè¿°æ˜¯ Internal Redirectï¼Œè€Œ 307 çŠ¶æ€ç æœ¬èº«çš„æè¿°æ˜¯ Temporary Redirectï¼Œï¼‰ç„¶åæ‰å‘å‡ºçœŸæ­£åˆ°è¾¾ç›®æ ‡æœåŠ¡å™¨çš„ HTTPS è¯·æ±‚ã€‚

é™¤äº†ç½‘ç«™æ‰‹åŠ¨è®¾ç½® Header `Strict-Transport-Security` ï¼Œè¿˜å¯ä»¥é€šè¿‡é¢„åŠ è½½ HSTS çš„æ–¹å¼ï¼Œå°†è‡ªå·±çš„åŸŸåæäº¤åˆ° Chrome è‡ªåŠ¨åŒ…å«çš„é¢„åŠ è½½åˆ—è¡¨ä¸­ã€‚

> è°·æ­Œç»´æŠ¤ç€ä¸€ä¸ª [HSTS é¢„åŠ è½½æœåŠ¡](https://hstspreload.appspot.com/)ã€‚æŒ‰ç…§å¦‚ä¸‹æŒ‡ç¤ºæˆåŠŸæäº¤ä½ çš„åŸŸååï¼Œæµè§ˆå™¨å°†ä¼šæ°¸ä¸ä½¿ç”¨éå®‰å…¨çš„æ–¹å¼è¿æ¥åˆ°ä½ çš„åŸŸåã€‚è™½ç„¶è¯¥æœåŠ¡æ˜¯ç”±è°·æ­Œæä¾›çš„ï¼Œä½†æ‰€æœ‰æµè§ˆå™¨éƒ½æœ‰ä½¿ç”¨è¿™ä»½åˆ—è¡¨çš„æ„å‘ï¼ˆæˆ–è€…å·²ç»åœ¨ç”¨äº†ï¼‰ã€‚ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯ HSTS æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸è¯¥è¢«å½“ä½œæ­£å¼çš„å†…å®¹ã€‚
>
> - Chrome & Chromium çš„ HSTS é¢„åŠ è½½åˆ—è¡¨ï¼š [https://www.chromium.org/hsts](https://www.chromium.org/hsts)
> - Firefox çš„ HSTS é¢„åŠ è½½åˆ—è¡¨ï¼š[nsSTSPreloadList.inc](https://dxr.mozilla.org/comm-central/source/mozilla/security/manager/ssl/nsSTSPreloadList.inc)

#### ä½œç”¨

ä½œç”¨ä¸ä¸è¶³å‡å‚è€ƒ[ç»´åŸº](https://zh.wikipedia.org/wiki/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8)ã€‚

> HSTS å¯ä»¥ç”¨æ¥æŠµå¾¡ SSL å‰¥ç¦»æ”»å‡»ã€‚SSL å‰¥ç¦»æ”»å‡»æ˜¯[ä¸­é—´äººæ”»å‡»](https://zh.wikipedia.org/wiki/ä¸­é—´äººæ”»å‡»)çš„ä¸€ç§ï¼Œç”± [Moxie Marlinspike](https://zh.wikipedia.org/w/index.php?title=Moxie_Marlinspike&action=edit&redlink=1) äº 2009 å¹´å‘æ˜ã€‚ä»–åœ¨å½“å¹´çš„é»‘å¸½å¤§ä¼šä¸Šå‘è¡¨çš„é¢˜ä¸º "New Tricks For Defeating SSL In Practice" çš„æ¼”è®²ä¸­å°†è¿™ç§æ”»å‡»æ–¹å¼å…¬å¼€ã€‚SSL å‰¥ç¦»çš„å®æ–½æ–¹æ³•æ˜¯é˜»æ­¢æµè§ˆå™¨ä¸æœåŠ¡å™¨åˆ›å»º HTTPS è¿æ¥ã€‚å®ƒçš„å‰ææ˜¯ç”¨æˆ·å¾ˆå°‘ç›´æ¥åœ¨åœ°å€æ è¾“å…¥ `https://`ï¼Œç”¨æˆ·æ€»æ˜¯é€šè¿‡ç‚¹å‡»é“¾æ¥æˆ– [3xx é‡å®šå‘](https://zh.wikipedia.org/wiki/3xxé‡å®šå‘)ï¼Œä» HTTP é¡µé¢è¿›å…¥ HTTPS é¡µé¢ã€‚æ‰€ä»¥æ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·è®¿é—® HTTP é¡µé¢æ—¶æ›¿æ¢æ‰€æœ‰ `https://` å¼€å¤´çš„é“¾æ¥ä¸º `http://`ï¼Œè¾¾åˆ°é˜»æ­¢ HTTPS çš„ç›®çš„ã€‚
>
> HSTS å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³ SSL å‰¥ç¦»æ”»å‡»ï¼Œå› ä¸ºåªè¦æµè§ˆå™¨æ›¾ç»ä¸æœåŠ¡å™¨åˆ›å»ºè¿‡ä¸€æ¬¡å®‰å…¨è¿æ¥ï¼Œä¹‹åæµè§ˆå™¨ä¼šå¼ºåˆ¶ä½¿ç”¨ HTTPSï¼Œå³ä½¿é“¾æ¥è¢«æ¢æˆäº† HTTPã€‚
>
> å¦å¤–ï¼Œå¦‚æœä¸­é—´äººä½¿ç”¨è‡ªå·±çš„è‡ªç­¾åè¯ä¹¦æ¥è¿›è¡Œæ”»å‡»ï¼Œæµè§ˆå™¨ä¼šç»™å‡ºè­¦å‘Šï¼Œä½†æ˜¯è®¸å¤šç”¨æˆ·ä¼šå¿½ç•¥è­¦å‘Šã€‚HSTS è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼Œä¸€æ—¦æœåŠ¡å™¨å‘é€äº† HSTS å­—æ®µï¼Œå°†ä¸å†å…è®¸ç”¨æˆ·å¿½ç•¥è­¦å‘Šã€‚

#### ä¸è¶³

> ç”¨æˆ·é¦–æ¬¡è®¿é—®æŸç½‘ç«™æ˜¯ä¸å— HSTS ä¿æŠ¤çš„ã€‚è¿™æ˜¯å› ä¸ºé¦–æ¬¡è®¿é—®æ—¶ï¼Œæµè§ˆå™¨è¿˜æœªæ”¶åˆ° HSTSï¼Œæ‰€ä»¥ä»æœ‰å¯èƒ½é€šè¿‡æ˜æ–‡ HTTP æ¥è®¿é—®ã€‚è§£å†³è¿™ä¸ªä¸è¶³å½“å‰æœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œä¸€æ˜¯æµè§ˆå™¨é¢„ç½® HSTS åŸŸååˆ—è¡¨ï¼Œ[Google Chrome](https://zh.wikipedia.org/wiki/Google_Chrome)ã€[Firefox](https://zh.wikipedia.org/wiki/Firefox)ã€[Internet Explorer ](https://zh.wikipedia.org/wiki/Internet_Explorer)å’Œ [Microsoft Edge](https://zh.wikipedia.org/wiki/Microsoft_Edge)å®ç°äº†è¿™ä¸€æ–¹æ¡ˆã€‚äºŒæ˜¯å°† HSTS ä¿¡æ¯åŠ å…¥åˆ°[åŸŸåç³»ç»Ÿ](https://zh.wikipedia.org/wiki/åŸŸåç³»ç»Ÿ)è®°å½•ä¸­ã€‚ä½†è¿™éœ€è¦ä¿è¯ DNS çš„å®‰å…¨æ€§ï¼Œä¹Ÿå°±æ˜¯éœ€è¦éƒ¨ç½²[åŸŸåç³»ç»Ÿå®‰å…¨æ‰©å±•](https://zh.wikipedia.org/wiki/åŸŸåç³»ç»Ÿå®‰å…¨æ‰©å±•)ã€‚æˆªè‡³ 2016 å¹´è¿™ä¸€æ–¹æ¡ˆæ²¡æœ‰å¤§è§„æ¨¡éƒ¨ç½²ã€‚
>
> ç”±äº HSTS ä¼šåœ¨ä¸€å®šæ—¶é—´åå¤±æ•ˆï¼ˆæœ‰æ•ˆæœŸç”± max-age æŒ‡å®šï¼‰ï¼Œæ‰€ä»¥æµè§ˆå™¨æ˜¯å¦å¼ºåˆ¶ HSTS ç­–ç•¥å–å†³äºå½“å‰ç³»ç»Ÿæ—¶é—´ã€‚éƒ¨åˆ†æ“ä½œç³»ç»Ÿç»å¸¸é€šè¿‡[ç½‘ç»œæ—¶é—´åè®®](https://zh.wikipedia.org/wiki/ç¶²çµ¡æ™‚é–“å”è­°)æ›´æ–°ç³»ç»Ÿæ—¶é—´ï¼Œå¦‚ [Ubuntu](https://zh.wikipedia.org/wiki/Ubuntu) æ¯æ¬¡è¿æ¥ç½‘ç»œæ—¶ã€[OS X Lion](https://zh.wikipedia.org/wiki/OS_X_Lion) æ¯éš”9åˆ†é’Ÿä¼šè‡ªåŠ¨è¿æ¥æ—¶é—´æœåŠ¡å™¨ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¼ªé€  NTP ä¿¡æ¯ï¼Œè®¾ç½®é”™è¯¯æ—¶é—´æ¥ç»•è¿‡ HSTSã€‚è§£å†³æ–¹æ³•æ˜¯è®¤è¯ NTP ä¿¡æ¯ï¼Œæˆ–è€…ç¦æ­¢ NTP å¤§å¹…åº¦å¢å‡æ—¶é—´ã€‚æ¯”å¦‚ [Windows 8](https://zh.wikipedia.org/wiki/Windows_8) æ¯ 7 å¤©æ›´æ–°ä¸€æ¬¡æ—¶é—´ï¼Œå¹¶ä¸”è¦æ±‚æ¯æ¬¡ NTP è®¾ç½®çš„æ—¶é—´ä¸å½“å‰æ—¶é—´ä¸å¾—è¶…è¿‡ 15 å°æ—¶ã€‚

## è§£å†³æ€è·¯

è™½ç„¶æœ€åè‡ªå·±è‚¯å®šä¼šä¸Š HTTPSï¼Œä¸Šäº†ä¹‹åè‚¯å®šå°±æ²¡è¿™ä¸ªé—®é¢˜äº†ï¼Œä½†æ˜¯å’±ä¸èƒ½è¿™æ ·å¯¹ä¸å¯¹ï¼Œå’±æ˜¯ä¸“ä¸šçš„ï¼Œæ‰€ä»¥æ¥è§£å†³ä¸‹ã€‚

åœ¨ StackOverflow ä¸Šå‘ç°è¿™æ ·å‡ ç§[è§£å†³æ–¹æ¡ˆ](https://stackoverflow.com/a/34213531)ã€‚

1. åœ¨ Chrome çš„ URL å­—æ®µä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š`chrome://net-internals/#hsts`ï¼Œç„¶åæœç´¢æ‚¨çš„ç½‘ç«™å¹¶å°†å…¶åˆ é™¤ã€‚ï¼ˆæœ€åæˆ‘é‡‡ç”¨çš„ğŸ˜‹ï¼‰
2. æ‚¨ä¹Ÿå¯ä»¥åœ¨é¡¶çº§åŸŸä¸­è®¾ç½®å®ƒå¹¶åŒ…æ‹¬å­åŸŸï¼Œå› æ­¤æ‚¨å¯èƒ½éœ€è¦ä»é‚£é‡Œåˆ é™¤ã€‚ï¼ˆåŸæ–‡ï¼šYou may also set this at a top level domain and include subdomains so you may need to delete from there.ï¼‰ï¼ˆæ²¡çœ‹å¤ªæ‡‚...æ„Ÿè§‰ä»–æƒ³æè¿°çš„æƒ…å†µæ˜¯ `Strict-Transport-Security` å­—æ®µä¸­è®¾ç½®äº†å­åŸŸçš„æƒ…å†µï¼Œè¯­æ³•ä¸º `Strict-Transport-Security: max-age=<expire-time>; includeSubDomains`ã€‚è¿™æ ·å½“å­åŸŸä¸å†éœ€è¦ HTTPS æ—¶ï¼Œå¯ä»¥å¯¹çˆ¶åŸŸçš„ Header è¿›è¡Œæ›´æ–°ä»¥ä¸¢å¼ƒ `includeSubDomains`ã€‚ï¼‰
3. æ›´æ”¹æœåŠ¡å™¨é…ç½®ä¸­çš„ Header `Strict-Transport-Security` å­—æ®µï¼šå…ˆå‘å¸ƒ `max-age` ä¸º 0 çš„ Headerï¼Œç„¶åé‡æ–°è®¿é—®ç½‘ç«™ä»¥æ¸…é™¤æ­¤ Headerï¼Œæœ€ååœæ­¢å‘å¸ƒæ­¤ Headerã€‚è¿™å¯¹äºå…¶ä»–ä¸å¤ªå®¹æ˜“æ¸…é™¤ Header çš„æµè§ˆå™¨å¾ˆæœ‰å¸®åŠ©ã€‚

> è¯·æ³¨æ„ï¼Œå¦‚æœç½‘ç«™ä½äºé¢„åŠ è½½åˆ—è¡¨ä¸­ï¼Œåˆ™æ— æ³•æ¸…é™¤æ­¤è®¾ç½®ï¼Œå› ä¸ºè¯¥ç½‘ç«™å·²åµŒå…¥åœ¨ Web æµè§ˆå™¨çš„ä»£ç ä¸­ã€‚ç½‘ç«™æ‰€æœ‰è€…å¯ä»¥æäº¤è¦ä»é¢„åŠ è½½åˆ—è¡¨ä¸­åˆ é™¤çš„è¯·æ±‚ï¼Œä½†è¿™éœ€è¦èŠ±å‡ ä¸ªæœˆçš„æ—¶é—´æ‰èƒ½å®Œæˆ Chrome çš„å‘å¸ƒå‘¨æœŸï¼Œè€Œå…¶ä»–æµè§ˆå™¨åˆ™æ²¡æœ‰æ˜ç¡®çš„æ—¶é—´è¡¨ã€‚å‡ºäºå®‰å…¨åŸå› ï¼ŒChrome ä¹Ÿæ— æ³•è¦†ç›–é¢„åŠ è½½çš„è®¾ç½®ã€‚

åœ¨ Chrome ä¸­é”®å…¥ `chrome://net-internals/#hsts`ï¼Œå…ˆæœç´¢åŸŸåï¼Œç»“æœå¦‚ä¸‹å›¾ã€‚åˆ é™¤åï¼Œå¯ä»¥é€šè¿‡ HTTP æ­£å¸¸è®¿é—®ã€‚

![](https://cdn.charlesfeng.top/images/2020-05-12-chrome-hsts-query.png)

å› ä¸º Chrome ç‰ˆæœ¬æ›´æ–°çš„é—®é¢˜ï¼ˆæˆ‘æ˜¯ v81.0.4044.138ï¼‰ï¼Œå…·ä½“ç•Œé¢è·Ÿ[æ­¤å¤„](https://really-simple-ssl.com/knowledge-base/clear-hsts-browser/)æè¿°çš„ä¸å¤ªä¸€æ ·ï¼Œæ‰€ä»¥ä¹Ÿè®°å½•ä¸‹ã€‚ï¼ˆ~~æ¶¨å­—æ•°~~ï¼‰

>1. In the address bar, type â€œchrome://net-internals/#hstsâ€.
>2. Type the domain name in the text field below â€œDelete domain security policiesâ€.
>3. Click the â€œDeleteâ€ button.
>4. Type the domain name in the text field below â€œQuery HSTS/PKP domainâ€.
>5. Click the â€œQueryâ€ button.
>6. Your response should be â€œNot foundâ€.

## Safari è¾ƒ Chrome çš„ä¸åŒ

ä¼°è®¡ Safari ä¹Ÿæ˜¯åŒæ ·çš„é—®é¢˜ï¼Œä½†æ˜¯æŒ‰ç…§ä¸Šè¿°è§£å†³æ–¹æ¡ˆçš„ Safari ç‰ˆæœ¬ï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰è§£å†³å¹¶æ²¡æœ‰è§£å†³é—®é¢˜...æ”¹å¤©å†æ‰¾æ‰¾å§ğŸ˜‚

>1. Close Safari.
>2. Delete the ~/Library/Cookies/HSTS.plist file.
>3. Reopen Safari.

## å‚è€ƒ

2. [å¦‚ä½•åˆ·æ–°æœ¬æœºDNSç¼“å­˜ï¼ˆWin+Linux+OSXï¼‰](https://blog.csdn.net/zhyl8157121/article/details/100551350)
3. [MDN 307 Temporary Redirect](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/307)
4. [MDN HSTS](https://developer.mozilla.org/zh-CN/docs/Glossary/HSTS)
5. [MDN HTTP Strict Transport Security](https://developer.mozilla.org/zh-CN/docs/Security/HTTP_Strict_Transport_Security)
6. [WIKI HTTP ä¸¥æ ¼ä¼ è¾“å®‰å…¨](https://zh.wikipedia.org/wiki/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8)
7. [Status Code:307 Internal Redirect å’Œ Non-Authoritative-Reason:HSTS é—®é¢˜](https://www.jianshu.com/p/005f3466b714)
8. [Non-Authoritative-Reason header field HTTP](https://stackoverflow.com/a/34213531)
9. [How to clear HSTS from your browser]([https://really-simple-ssl.com/knowledge-base/clear-hsts-browser/])

